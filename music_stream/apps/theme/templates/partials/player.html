{% load static %}
<div class="player-container w-full px-4 pb-4">
    <!-- Музыкальный плеер -->
    <div id="player" class="player-slide-in border border-gray-500 bg-zinc-950 rounded-2xl shadow-lg">
        <div class="max-w-7xl mx-auto p-4 flex flex-col md:flex-row items-center">
            <!-- Информация о треке -->
            <div class="flex items-center w-full md:w-1/3 mb-4 md:mb-0">
                <div class="album-cover w-14 h-14 rounded-full overflow-hidden mr-3 border border-gray-600">
                    <img id="current-album-cover" src="{% static 'images/default-cover.jpg' %}" alt="Album Cover"
                        class="w-full h-full object-cover">
                </div>
                <div class="truncate flex-1">
                    <div id="current-track" class="text-white font-medium truncate">Выберите трек</div>
                    <div id="current-artist" class="text-gray-400 text-sm truncate">Исполнитель</div>
                </div>
                <button id="like-button" class="ml-3 text-gray-400 hover:text-rose-500">
                    <i class="far fa-heart"></i>
                </button>
            </div>

            <!-- Основные элементы управления -->
            <div class="flex-1 flex flex-col items-center w-full md:w-1/3 mb-4 md:mb-0">
                <div class="flex items-center space-x-4">
                    <button id="shuffle-button" class="text-gray-400 hover:text-white">
                        <i class="fas fa-random"></i>
                    </button>
                    <button id="prev-button" class="text-white">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button id="play-button"
                        class="w-10 h-10 rounded-full bg-rose-600 flex items-center justify-center hover:bg-rose-700">
                        <i id="play-icon" class="fas fa-play text-white"></i>
                    </button>
                    <button id="next-button" class="text-white">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button id="repeat-button" class="text-gray-400 hover:text-white">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                <div class="w-full max-w-xl flex items-center mt-2">
                    <span id="current-time" class="text-xs text-gray-400 mr-2">0:00</span>
                    <input type="range" id="progress-bar" class="progress-bar flex-1" min="0" max="100" value="0">
                    <span id="total-time" class="text-xs text-gray-400 ml-2">0:00</span>
                </div>
            </div>

            <!-- Дополнительные элементы управления -->
            <div class="w-full md:w-1/3 flex items-center justify-end">
                <div class="flex items-center w-full md:w-auto justify-center">
                    <button id="volume-button" class="text-gray-400 hover:text-white mr-2">
                        <i id="volume-icon" class="fas fa-volume-up"></i>
                    </button>
                    <input type="range" id="volume-slider" class="volume-slider w-24" min="0" max="100" value="80">
                </div>
            </div>
        </div>

        <!-- Аудио элемент -->
        <audio id="audio-player" class="hidden"></audio>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const playerContainer = document.querySelector('.player-container');
            const audioPlayer = document.getElementById('audio-player');
            const currentTrackElement = document.getElementById('current-track');
            const currentArtistElement = document.getElementById('current-artist');
            const currentAlbumCover = document.getElementById('current-album-cover');
            const playButton = document.getElementById('play-button');
            const playIcon = document.getElementById('play-icon');
            const progressBar = document.getElementById('progress-bar');
            const currentTimeElement = document.getElementById('current-time');
            const totalTimeElement = document.getElementById('total-time');
            const volumeSlider = document.getElementById('volume-slider');
            const volumeIcon = document.getElementById('volume-icon');

            let hls = null;
            let isPlaying = false;

            // Обработчик события playTrack
            document.addEventListener('playTrack', function (e) {
                const track = e.detail;
                loadTrack(track);
            });

            // Функция загрузки трека
            function loadTrack(track) {
                // Обновляем информацию о треке
                currentTrackElement.textContent = track.title;
                currentArtistElement.textContent = track.artist;
                currentAlbumCover.src = track.coverUrl;

                // Показываем плеер
                playerContainer.style.display = 'block';

                // Останавливаем предыдущее воспроизведение
                if (hls) {
                    hls.destroy();
                }
                audioPlayer.pause();

                // Загружаем новый трек
                if (Hls.isSupported()) {
                    hls = new Hls();
                    hls.loadSource(track.playlistUrl);
                    hls.attachMedia(audioPlayer);

                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        // Обновляем длительность трека
                        updateDuration();

                        audioPlayer.play();
                        isPlaying = true;
                        playIcon.className = 'fas fa-pause';

                        // Обновляем прогресс каждую секунду
                        audioPlayer.addEventListener('timeupdate', updateProgress);
                    });
                } else if (audioPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    audioPlayer.src = track.playlistUrl;
                    audioPlayer.addEventListener('loadedmetadata', () => {
                        // Обновляем длительность трека
                        updateDuration();

                        audioPlayer.play();
                        isPlaying = true;
                        playIcon.className = 'fas fa-pause';

                        // Обновляем прогресс каждую секунду
                        audioPlayer.addEventListener('timeupdate', updateProgress);
                    });
                }
            }

            // Обновление длительности трека
            function updateDuration() {
                const duration = audioPlayer.duration;
                if (isFinite(duration)) {
                    const minutes = Math.floor(duration / 60);
                    const seconds = Math.floor(duration % 60);
                    totalTimeElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                }
            }

            // Обновление прогресса воспроизведения
            function updateProgress() {
                const currentTime = audioPlayer.currentTime;
                const duration = audioPlayer.duration;

                if (isFinite(duration)) {
                    const progressPercent = (currentTime / duration) * 100;
                    progressBar.value = progressPercent;

                    // Обновляем текущее время
                    const minutes = Math.floor(currentTime / 60);
                    const seconds = Math.floor(currentTime % 60);
                    currentTimeElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                }
            }

            // Перемотка трека
            progressBar.addEventListener('input', function () {
                if (audioPlayer.duration) {
                    const seekTime = (progressBar.value / 100) * audioPlayer.duration;
                    audioPlayer.currentTime = seekTime;
                }
            });

            // Управление громкостью
            volumeSlider.addEventListener('input', function () {
                audioPlayer.volume = volumeSlider.value / 100;

                // Обновляем иконку громкости
                if (audioPlayer.volume === 0) {
                    volumeIcon.className = 'fas fa-volume-mute';
                } else if (audioPlayer.volume < 0.5) {
                    volumeIcon.className = 'fas fa-volume-down';
                } else {
                    volumeIcon.className = 'fas fa-volume-up';
                }
            });

            // Кнопка громкости (mute/unmute)
            volumeIcon.addEventListener('click', function () {
                if (audioPlayer.volume > 0) {
                    // Сохраняем предыдущее значение
                    volumeSlider.dataset.prevVolume = volumeSlider.value;
                    volumeSlider.value = 0;
                    audioPlayer.volume = 0;
                    volumeIcon.className = 'fas fa-volume-mute';
                } else {
                    // Восстанавливаем предыдущее значение
                    const prevVolume = volumeSlider.dataset.prevVolume || 80;
                    volumeSlider.value = prevVolume;
                    audioPlayer.volume = prevVolume / 100;

                    if (audioPlayer.volume < 0.5) {
                        volumeIcon.className = 'fas fa-volume-down';
                    } else {
                        volumeIcon.className = 'fas fa-volume-up';
                    }
                }
            });

            // Управление воспроизведением
            playButton.addEventListener('click', function () {
                if (isPlaying) {
                    audioPlayer.pause();
                    playIcon.className = 'fas fa-play';
                } else {
                    audioPlayer.play();
                    playIcon.className = 'fas fa-pause';
                }
                isPlaying = !isPlaying;
            });

            // Обработчик окончания трека
            audioPlayer.addEventListener('ended', function () {
                isPlaying = false;
                playIcon.className = 'fas fa-play';
            });
        });
    </script>
</div>